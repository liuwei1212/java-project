<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>æ´»åŠ¨è¯¦æƒ…</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
<div class="banner">
    <img src="https://img.icons8.com/color/48/000000/school-building.png" class="logo" alt="logo"/>
    æ ¡å›­å…¬å‘Š/æ´»åŠ¨å‘å¸ƒç³»ç»Ÿ
</div>
<div class="container">
<h2 th:text="${event.title}"></h2>
<p th:text="${event.description}"></p>
<p>åœ°ç‚¹ï¼š<span th:text="${event.location}"></span></p>
<p>å¼€å§‹æ—¶é—´ï¼š<span th:text="${#dates.format(event.startTime, 'yyyy-MM-dd HH:mm')}"></span></p>
<p>ç»“æŸæ—¶é—´ï¼š<span th:text="${#dates.format(event.endTime, 'yyyy-MM-dd HH:mm')}"></span></p>
<h3>æŠ¥ååˆ—è¡¨</h3>
<ul>
    <li th:each="r : ${registrations}" th:if="${r.userId == session.user?.id}" th:text="${r.userId}"></li>
</ul>
<h3>æˆ‘è¦æŠ¥å</h3>
<div th:if="${session.user != null}">
    <form th:if="${!hasRegistered}" th:action="@{/event/register}" method="post">
        <input type="hidden" name="eventId" th:value="${event.id}">
        <input type="hidden" name="userId" th:value="${session.user.id}">
        <button type="submit">æŠ¥å</button>
    </form>
    <p th:if="${hasRegistered}" style="color:green;">ä½ å·²æŠ¥åè¯¥æ´»åŠ¨ï¼</p>
</div>
<div th:if="${session.user == null}">
    <p>è¯· <a th:href="@{/user/login}">ç™»å½•</a> åæŠ¥åã€‚</p>
</div>
<a th:href="@{/event/list}">è¿”å›åˆ—è¡¨</a>

<hr>
<h3>è¯„è®ºåŒº</h3>
<div th:if="${session.user != null}">
    <form th:action="@{/comment/add}" method="post">
        <input type="hidden" name="targetType" value="event">
        <input type="hidden" name="targetId" th:value="${event.id}">
        <textarea name="content" placeholder="è¯·è¾“å…¥è¯„è®ºå†…å®¹" required></textarea><br>
        <input type="hidden" name="userId" th:value="${session.user.id}">
        <button type="submit">å‘è¡¨è¯„è®º</button>
    </form>
</div>
<div th:if="${session.user == null}">
    <p>è¯· <a th:href="@{/user/login}">ç™»å½•</a> åå‚ä¸è¯„è®ºã€‚</p>
</div>
<ul>
    <li th:each="c : ${comments}">
        <b th:text="${c.username}"></b>ï¼š<span th:text="${c.content}"></span> <span th:text="${#dates.format(c.createTime, 'yyyy-MM-dd HH:mm')}"></span>
        <button type="button" th:attr="data-id=${c.id}" th:classappend="${c.liked} ? 'liked' : ''" onclick="toggleLike(this)">
            ğŸ‘ <span th:text="${c.likeCount}"></span>
        </button>
    </li>
</ul>
<script>
function toggleLike(btn) {
    var commentId = btn.getAttribute('data-id');
    var liked = btn.classList.contains('liked');
    var url = liked ? '/comment/unlike' : '/comment/like';
    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'commentId=' + commentId
    }).then(r => r.json()).then(data => {
        if (data.success !== false) {
            btn.classList.toggle('liked');
            btn.querySelector('span').innerText = data.count;
        } else {
            alert(data.msg || 'æ“ä½œå¤±è´¥');
        }
    });
}
</script>
<style>
button.liked { color: #e91e63; font-weight: bold; }
</style>
</div>
</body>
</html> 